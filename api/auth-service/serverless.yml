service: screen-driver-auth-api

frameworkVersion: ">=1.20.1 <2.0.0"

provider:
  name: aws
  runtime: nodejs6.10
  environment:
    STAGE: ${opt:stage}
    USER_POOL: ${self:service}-userpool-${opt:stage}
    USER_POOL_ID:
      Ref: CognitoUserPool
    USER_POOL_CLIENT: ${self:service}-appclient-${opt:stage}
    USER_POOL_CLIENT_ID:
      Ref: CognitoAppClient
  iamRoleStatements:
    - Effect: Allow
      Action:
        - cognito-idp:*
      Resource: arn:aws:cognito-idp:*

functions:
  authenticate:
    handler: src/auth/authenticator.handler

  sign_out:
    handler: src/auth/sign_out.handler
    events:
      - http:
          path: api/sign_out
          method: post
          cors: true

  refresh_token:
    handler: src/auth_token/auth_token.refresh
    events:
      - http:
          path: api/token/refresh
          method: post
          cors: true

resources:
  Resources:
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:provider.environment.USER_POOL}
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: false
        AdminCreateUserConfig:
          AllowAdminCreateUserOnly: true
        Schema:
          - AttributeDataType: Boolean
            Mutable: true
            Name: admin

    CognitoAppClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:provider.environment.USER_POOL_CLIENT}
        RefreshTokenValidity: 1
        UserPoolId:
          Ref: CognitoUserPool

    ApiAuthResource:
      Type: AWS::ApiGateway::Resource
      Properties:
        ParentId:
          Fn::ImportValue: ScreenDriverRootApiResource
        PathPart: auth
        RestApiId:
          Fn::ImportValue: ScreenDriverRestApi

    ApiAuthOptionsMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        AuthorizationType: NONE
        HttpMethod: OPTIONS
        MethodResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Access-Control-Allow-Headers: true
              method.response.header.Access-Control-Allow-Methods: true
              method.response.header.Access-Control-Allow-Credentials: true
        Integration:
          Type: MOCK
          RequestTemplates:
            application/json: "{statusCode:200}"
          IntegrationResponses:
            - StatusCode: 200
              ResponseParameters:
                method.response.header.Access-Control-Allow-Origin: "'*'"
                method.response.header.Access-Control-Allow-Headers: "'Content-TypeX-Amz-DateAuthorizationX-Api-KeyX-Amz-Security-TokenX-Amz-User-Agent'"
                method.response.header.Access-Control-Allow-Methods: "'OPTIONS,POST'"
                method.response.header.Access-Control-Allow-Credentials: "'false'"
        ResourceId:
          Ref: ApiAuthResource
        RestApiId:
          Fn::ImportValue: ScreenDriverRestApi

    ApiAuthMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        AuthorizationType: NONE
        HttpMethod: POST
        ResourceId:
          Ref: ApiAuthResource
        RestApiId:
          Fn::ImportValue: ScreenDriverRestApi
        Integration:
          Type: AWS_PROXY
          IntegrationHttpMethod: POST
          Uri:
            Fn::Join:
              - ''
              - - 'arn:aws:apigateway:'
                - Ref:
                    AWS::Region
                - ':lambda:path/2015-03-31/functions/'
                - Fn::GetAtt:
                  - AuthenticateLambdaFunction
                  - Arn
                - '/invocations'


plugins:
  - serverless-offline
  - serverless-export-env

package:
  exclude:
    - .*
    - package*
